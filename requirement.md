# Stationhead 自動配信システム 要件定義書

## 1. プロジェクト概要

### 1.1 目的
Stationheadでの配信作業（ログイン、Spotify連携、配信設定、プレイリスト選択、配信開始/終了）を自動化し、人が見守らなくても日次や定期的な配信を実行できるようにする。

### 1.2 背景
現在、手動で以下の作業を行っている:
- Stationheadへのログイン
- Spotify連携
- 配信名の設定
- プレイリストの選択
- 定時での配信開始
- プレイリスト終了時の再選択（ループ再生）
- 指定時間での配信終了

最大で30日間連続、1日5時間などの長時間運用が必要なケースがあり、手動運用の負担が大きい。

### 1.3 対象ユーザー
- 非エンジニアでも操作可能なインターフェースが必要
- 配信スケジュールを事前に登録し、自動実行させたいユーザー

## 2. 機能要件

### 2.1 配信スケジュール管理機能

#### 2.1.1 スケジュール登録
以下の情報を設定可能にする:
- **配信開始日時**: YYYY-MM-DD HH:MM 形式
- **配信終了日時**: YYYY-MM-DD HH:MM 形式
- **配信タイトル**: 配信ごとに異なるタイトルを設定可能
- **プレイリスト名**: 配信ごとに異なるプレイリストを指定可能
- **実行ステータス**: 予約中/実行中/完了/エラー

#### 2.1.2 スケジュール管理
- 登録済みスケジュールの一覧表示
- スケジュールの編集・削除機能
- **時間重複チェック**: 同時実行を防ぐため、重複する時間帯のスケジュールは登録不可
- スケジュールの実行履歴確認

#### 2.1.3 ユーザーインターフェース
- **要検討**: 非エンジニアでも使いやすいインターフェース
  - 候補1: Web UI（ローカルサーバーでブラウザから操作）
  - 候補2: CLIツール（コマンド実行）
  - 候補3: 設定ファイル編集 + 管理画面
- 最終的には使いやすさを優先して選定

### 2.2 自動ログイン・認証機能

#### 2.2.1 Stationheadログイン
- Web版Stationheadへの自動ログイン
- **要調査**: 2段階認証への対応方法
  - セッション保存による再利用
  - 認証情報の安全な保管方法
  - 認証トークンの有効期限管理

#### 2.2.2 Spotify連携
- Spotify認証の自動化
- **要調査**: OAuth認証フローの自動化手法
- 認証トークンのリフレッシュ対応

#### 2.2.3 認証情報管理
- **要検討**: 開発しながら最適な方法を選定
  - 環境変数（.envファイル）
  - 暗号化された設定ファイル
  - セッション情報の永続化
  - OS標準のキーチェーン利用

### 2.3 配信実行機能

#### 2.3.1 配信開始
- 指定日時に自動的に配信を開始
- 配信タイトルの自動設定
- プレイリストの自動選択
- 再生開始の自動実行

#### 2.3.2 プレイリストループ再生
- プレイリストの最後まで再生完了を検知
- **要調査**: 終了検知の方法
  - 画面上の状態変化（DOM要素の監視）
  - プレイリスト情報からの再生時間計算
  - Stationhead/Spotify APIの利用可否
- 終了検知後、同じプレイリストの1曲目から再選択して再生
- 終了時刻まで上記動作を繰り返す

#### 2.3.3 配信終了
- 指定終了日時に達したら配信を停止
- プレイリストの途中でも終了可能
- 正常終了時のクリーンアップ処理

### 2.4 ブラウザ自動化

#### 2.4.1 技術選定
- **要検討**: 最適な最新技術を選定
  - Playwright（推奨候補: 安定性・速度・機能面で優位）
  - Puppeteer
  - Selenium
- ヘッドレスモードとヘッドありモードの切り替え

#### 2.4.2 自動操作
- StationheadのWeb UIの自動操作
- ページ遷移の待機処理
- エラー時のリトライ処理
- スクリーンショットによる状態記録

### 2.5 監視・エラー通知機能

#### 2.5.1 Slack通知
- エラー発生時の即時通知
- 通知内容:
  - エラー内容の詳細
  - 発生日時
  - 該当するスケジュール情報
  - スクリーンショット（可能な場合）
- 通知先: 特定のSlackチャンネル
- 重要度に応じた通知レベル設定

#### 2.5.2 正常系通知（オプション）
- 配信開始通知
- 配信終了通知
- プレイリストループ通知

### 2.6 ログ管理機能

#### 2.6.1 ログ記録
- 実行ログの詳細記録:
  - 配信開始/終了時刻
  - プレイリスト選択・再生状況
  - エラー発生箇所と内容
  - 自動操作の各ステップ
- ログレベル: DEBUG, INFO, WARNING, ERROR

#### 2.6.2 ログ保存
- ローカルファイルへの保存
- ログローテーション（古いログの自動削除）
- 日付別のログファイル管理

#### 2.6.3 ログ閲覧
- ログファイルの検索・フィルタリング
- 管理画面からのログ閲覧（UI実装時）

## 3. 非機能要件

### 3.1 実行環境
- **プラットフォーム**: Mac/Windows（ローカルPC）
- **ブラウザ**: Chromiumベース（自動化用）
- **実行方式**:
  - **要検討**: 常駐型 vs 定期チェック型
    - 常駐型: プロセスを常時起動しておき、スケジュールを監視
    - 定期チェック型: OS標準のスケジューラー（cron/タスクスケジューラー）で定期的に起動
  - 長時間運用（24時間連続など）を考慮した安定性

### 3.2 技術スタック

#### 3.2.1 プログラミング言語
- **要検討**: 最適な最新技術を選定
  - 候補1: **TypeScript + Node.js**
    - 理由: ブラウザ自動化ツール（Playwright）との親和性が高い、非同期処理が得意
  - 候補2: **Python**
    - 理由: 自動化スクリプトの実装が容易、豊富なライブラリ
- モダンな開発体験と保守性を重視

#### 3.2.2 データ管理
- **要検討**: スケジュール管理の規模に応じて選定
  - 小規模（~100件）: JSONファイルまたはSQLite
  - 中規模以上: PostgreSQL, MySQL等
- 初期はファイルベース、必要に応じてDB移行可能な設計

#### 3.2.3 推奨技術スタック案
```
言語: TypeScript + Node.js
ブラウザ自動化: Playwright
スケジューラー: node-cron または OS標準スケジューラー
データ管理: SQLite（小規模）または JSON（超軽量）
Slack通知: @slack/webhook
ログ管理: winston または pino
UI（検討中）: Express + React/Vue（軽量SPA）または CLI
```

### 3.3 パフォーマンス
- 配信開始の遅延: 指定時刻から±2分以内
- プレイリストループの遅延: 終了検知から5秒以内に再選択
- メモリ使用量: 500MB以下（長時間運用時）

### 3.4 信頼性
- エラー発生時の自動リトライ（最大3回）
- ネットワーク障害時の再接続
- 予期せぬブラウザクラッシュからの復旧
- 配信実行中のシステムクラッシュ時の状態復元

### 3.5 セキュリティ
- 認証情報の暗号化保存
- 平文パスワードの禁止
- ログファイルに機密情報を含めない
- Slack Webhook URLの安全な管理

### 3.6 保守性
- コードのモジュール化
- 設定の外部化
- テストコードの整備（主要機能）
- ドキュメントの整備（README、セットアップ手順）

## 4. システム構成案

### 4.1 アーキテクチャ概要
```
┌─────────────────────────────────────────┐
│         ユーザーインターフェース          │
│  （Web UI / CLI / 設定ファイル編集）      │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│       スケジュール管理モジュール          │
│  - スケジュール登録/編集/削除             │
│  - 時間重複チェック                       │
│  - 実行状態管理                          │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         スケジューラー実行エンジン        │
│  - 実行タイミング監視                     │
│  - 配信タスクの起動                       │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│       ブラウザ自動化モジュール            │
│  - Stationheadログイン                   │
│  - Spotify連携                           │
│  - 配信設定・開始                        │
│  - プレイリスト選択・ループ               │
│  - 配信終了                              │
└──────────────┬──────────────────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
┌───▼──────┐      ┌───────▼────────┐
│ログ記録   │      │  Slack通知     │
│モジュール │      │  モジュール    │
└───────────┘      └────────────────┘
```

### 4.2 ディレクトリ構成案
```
stationhead-auto-streamer/
├── src/
│   ├── browser/          # ブラウザ自動化
│   │   ├── auth.ts       # 認証処理
│   │   ├── stream.ts     # 配信操作
│   │   └── playlist.ts   # プレイリスト操作
│   ├── scheduler/        # スケジューラー
│   │   ├── manager.ts    # スケジュール管理
│   │   └── executor.ts   # 実行エンジン
│   ├── notification/     # 通知
│   │   └── slack.ts
│   ├── logger/           # ログ
│   │   └── logger.ts
│   ├── ui/               # ユーザーインターフェース
│   │   ├── cli.ts        # CLI（初期実装）
│   │   └── web/          # Web UI（将来実装）
│   └── config/           # 設定管理
│       └── config.ts
├── data/                 # データ保存
│   ├── schedules.json    # スケジュール情報
│   └── sessions/         # セッション情報
├── logs/                 # ログファイル
├── tests/                # テストコード
├── docs/                 # ドキュメント
├── .env.example          # 環境変数テンプレート
├── .env                  # 環境変数（Git除外）
├── package.json
├── tsconfig.json
└── README.md
```

## 5. 開発フェーズ

### Phase 1: 基盤構築（要調査フェーズ含む）
- [ ] 技術スタックの最終決定
- [ ] プロジェクトセットアップ
- [ ] StationheadのWeb UI構造調査
- [ ] 認証方式の調査と実装方針決定
- [ ] ブラウザ自動化による基本操作の実装
  - [ ] ログイン
  - [ ] Spotify連携
  - [ ] 配信開始
  - [ ] プレイリスト選択・再生
  - [ ] 配信終了
- [ ] プレイリスト終了検知の方法調査・実装

### Phase 2: コア機能実装
- [ ] スケジュール管理モジュール実装
- [ ] 時間重複チェック機能
- [ ] スケジューラー実行エンジン実装
- [ ] プレイリストループ再生機能
- [ ] ログ記録機能
- [ ] Slack通知機能

### Phase 3: UI実装
- [ ] ユーザーインターフェースの方式決定
- [ ] スケジュール登録UI実装
- [ ] スケジュール一覧・管理画面実装
- [ ] ログ閲覧機能実装（オプション）

### Phase 4: 安定化・最適化
- [ ] エラーハンドリング強化
- [ ] リトライ処理実装
- [ ] 長時間運用テスト
- [ ] メモリリーク対策
- [ ] パフォーマンス最適化

### Phase 5: ドキュメント・デプロイ
- [ ] セットアップ手順書作成
- [ ] 運用マニュアル作成
- [ ] トラブルシューティングガイド作成

## 6. リスクと対応策

### 6.1 技術的リスク
| リスク | 影響度 | 対応策 |
|--------|--------|--------|
| Stationhead UI変更により自動化が動作不能 | 高 | セレクタの柔軟な設定、定期的なメンテナンス計画 |
| 2段階認証による自動ログイン失敗 | 高 | セッション永続化、手動ログイン補助機能 |
| プレイリスト終了検知の不確実性 | 中 | 複数の検知方法を実装、フォールバック処理 |
| 長時間運用でのメモリリーク | 中 | 定期的なブラウザ再起動、メモリ監視 |
| ネットワーク障害 | 中 | 自動リトライ、エラー通知、手動復旧手順 |

### 6.2 運用リスク
| リスク | 影響度 | 対応策 |
|--------|--------|--------|
| PCのスリープによる実行停止 | 高 | スリープ無効化手順の明記、電源管理設定 |
| 認証トークン期限切れ | 中 | 自動リフレッシュ、期限切れ検知と通知 |
| スケジュール設定ミス | 低 | 重複チェック、確認画面の実装 |

## 7. 成功基準

- [ ] 非エンジニアが30分以内にセットアップ可能
- [ ] スケジュール登録から実行まで手動介入不要
- [ ] 配信成功率95%以上（30日間運用）
- [ ] エラー発生時、5分以内にSlack通知
- [ ] プレイリストループが正常に動作（終了検知成功率90%以上）
- [ ] 24時間連続運用が安定して動作

## 8. 今後の拡張可能性

- 複数アカウント対応
- 複数プレイリストのランダム選択
- 配信統計レポート機能
- Webフック連携（外部サービスからのスケジュール登録）
- モバイルアプリでの管理
- クラウド版への移行（24時間稼働サーバー）

## 9. 補足事項

### 9.1 要調査事項
以下の項目は開発を進めながら調査・決定する:
1. Stationhead/Spotifyの2段階認証の具体的な動作
2. プレイリスト終了の確実な検知方法
3. 最適な認証情報管理方法
4. システム常駐 vs 定期起動の最終判断
5. 非エンジニア向けの最適なUI形式

### 9.2 想定外の事項への対応
- StationheadのAPI提供が判明した場合、ブラウザ自動化からAPI利用へ移行検討
- Stationheadの利用規約に抵触しないか確認（自動化の可否）

---

**作成日**: 2025-11-11
**バージョン**: 1.0
**ステータス**: Draft
